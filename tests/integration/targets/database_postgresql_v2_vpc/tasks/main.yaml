- name: database_postgresql_v2_vpc
  block:
    - set_fact:
        r: "{{ 1000000000 | random }}"

    - name: List regions
      linode.cloud.region_list:
      register: all_regions

    - set_fact:
        target_region: '{{ (all_regions.regions | selectattr("capabilities", "search", "Databases") | selectattr("capabilities", "search", "VPCs") | list)[0]["id"] }}'

    - name: Get an available PostgreSQL engine
      linode.cloud.database_engine_list:
        filters:
          - name: engine
            values: postgresql
      register: available_engines

    - name: Assert available database_engine_list
      assert:
        that:
          - available_engines.database_engines | length >= 1

    - set_fact:
        engine_id: "{{ available_engines.database_engines[0]['id'] }}"
        engine_version: "{{ available_engines.database_engines[0]['version'] }}"

    - name: Create a VPC
      linode.cloud.vpc:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        state: present
      register: create_vpc

    - name: Create a subnet
      linode.cloud.vpc_subnet:
        vpc_id: "{{ create_vpc.vpc.id }}"
        label: "test-subnet-1"
        ipv4: "10.0.0.0/24"
        state: present
      register: create_subnet_1

    - name: Create a second subnet
      linode.cloud.vpc_subnet:
        vpc_id: "{{ create_vpc.vpc.id }}"
        label: "test-subnet-2"
        ipv4: "10.0.1.0/24"
        state: present
      register: create_subnet_2

    - name: Create a database
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        private_network:
          vpc_id: "{{ create_vpc.vpc.id }}"
          subnet_id: '{{ create_subnet_1.subnet.id }}'
          public_access: false
        state: present
      register: db_create

    - name: Assert database is created
      assert:
        that:
          - db_create.changed
          - db_create.database.status == "active"
          - db_create.database.private_network.vpc_id == create_vpc.vpc.id
          - db_create.database.private_network.subnet_id == create_subnet_1.subnet.id
          - db_create.database.private_network.public_access == False

    - name: Update the database private network configuration
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        private_network:
          vpc_id: "{{ create_vpc.vpc.id }}"
          subnet_id: '{{ create_subnet_2.subnet.id }}'
          public_access: true
        state: present
      register: db_update

    - name: Assert database is created
      assert:
        that:
          - db_update.changed
          - db_update.database.status == "active"
          - db_update.database.private_network.vpc_id == create_vpc.vpc.id
          - db_update.database.private_network.subnet_id == create_subnet_2.subnet.id
          - db_update.database.private_network.public_access == True

    - name: Don't change the private network configuration
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        private_network:
          vpc_id: "{{ create_vpc.vpc.id }}"
          subnet_id: '{{ create_subnet_2.subnet.id }}'
          public_access: true
        state: present
      register: db_unchanged

    - name: Assert the database is unchanged
      assert:
        that:
          - db_unchanged.changed == False
          - db_unchanged.database.status == "active"
          - db_unchanged.database.private_network.vpc_id == create_vpc.vpc.id
          - db_unchanged.database.private_network.subnet_id == create_subnet_2.subnet.id
          - db_unchanged.database.private_network.public_access == True

    - name: Get information about the database by label
      linode.cloud.database_postgresql_info:
        label: "ansible-test-{{ r }}"
      register: db_info_label

    - name: Assert the database is found by label
      assert:
        that:
          - db_info_label.database.status == "active"
          - db_info_label.database.private_network.vpc_id == create_vpc.vpc.id
          - db_info_label.database.private_network.subnet_id == create_subnet_2.subnet.id
          - db_info_label.database.private_network.public_access == True

    - name: Get information about the database by ID
      linode.cloud.database_postgresql_info:
        id: "{{ db_create.database.id }}"
      register: db_info_id

    - name: Assert the database is found by ID
      assert:
        that:
          - db_info_id.database.status == "active"
          - db_info_id.database.private_network.vpc_id == create_vpc.vpc.id
          - db_info_id.database.private_network.subnet_id == create_subnet_2.subnet.id
          - db_info_id.database.private_network.public_access == True

    - name: Get information about the VPC subnet by ID
      linode.cloud.vpc_subnet_info:
        vpc_id: "{{ create_vpc.vpc.id }}"
        id: '{{ create_subnet_2.subnet.id }}'
      register: subnet_info

    - name: Assert the database is found by ID
      assert:
        that:
          - subnet_info.subnet.databases[0].id == db_create.database.id
          - dsubnet_info.subnet.databases[0].ipv4_range != None
          - dsubnet_info.subnet.databases[0].ipv6_range != None
  always:
    - ignore_errors: true
      block:
        - name: Delete database
          linode.cloud.database_postgresql_v2:
            label: "{{ db_create.database.label }}"
            state: absent

        - name: Delete VPC
          linode.cloud.vpc:
            label: "ansible-test-{{ r }}"
            region: "{{ target_region }}"
            state: absent

  environment:
    LINODE_UA_PREFIX: "{{ ua_prefix }}"
    LINODE_API_TOKEN: "{{ api_token }}"
    LINODE_API_URL: "{{ api_url }}"
    LINODE_API_VERSION: "{{ api_version }}"
    LINODE_CA: "{{ ca_file or '' }}"