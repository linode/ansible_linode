- name: database_postgresql_v2_vpc_detach
  block:
    - set_fact:
        r: "{{ 1000000000 | random }}"

    - name: List regions
      linode.cloud.region_list:
      register: all_regions

    - set_fact:
        target_region: '{{ (all_regions.regions | selectattr("capabilities", "search", "Databases") | selectattr("capabilities", "search", "VPCs") | list)[0]["id"] }}'

    - name: Get an available PostgreSQL engine
      linode.cloud.database_engine_list:
        filters:
          - name: engine
            values: postgresql
      register: available_engines

    - name: Assert available database_engine_list
      assert:
        that:
          - available_engines.database_engines | length >= 1

    - set_fact:
        engine_id: "{{ available_engines.database_engines[0]['id'] }}"
        engine_version: "{{ available_engines.database_engines[0]['version'] }}"

    - name: Create a VPC
      linode.cloud.vpc:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        state: present
      register: create_vpc

    - name: Create a subnet
      linode.cloud.vpc_subnet:
        vpc_id: "{{ create_vpc.vpc.id }}"
        label: "test-subnet-1"
        ipv4: "10.0.0.0/24"
        state: present
      register: create_subnet_1

    - name: Create a database
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        private_network:
          vpc_id: "{{ create_vpc.vpc.id }}"
          subnet_id: '{{ create_subnet_1.subnet.id }}'
          public_access: false
        state: present
      register: db_create

    - name: Assert database is created
      assert:
        that:
          - db_create.changed
          - db_create.database.status == "active"
          - db_create.database.private_network.vpc_id == create_vpc.vpc.id
          - db_create.database.private_network.subnet_id == create_subnet_1.subnet.id
          - db_create.database.private_network.public_access == False

    - name: Remove the private network configuration
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        detach_private_network: true
        state: present
      register: db_remove_private_network

    - name: Assert the database is unchanged
      assert:
        that:
          - db_remove_private_network.changed
          - db_remove_private_network.database.status == "active"
          - db_remove_private_network.database.private_network == None

    - name: Don't make any changes
      linode.cloud.database_postgresql_v2:
        label: "ansible-test-{{ r }}"
        region: "{{ target_region }}"
        engine: "{{ engine_id }}"
        type: g6-nanode-1
        detach_private_network: true
        state: present
      register: db_remove_private_network_unchanged

    - name: Assert the database is unchanged
      assert:
        that:
          - db_remove_private_network_unchanged.changed == False
          - db_remove_private_network_unchanged.database.status == "active"
          - db_remove_private_network_unchanged.database.private_network == None

  always:
    - ignore_errors: true
      block:
        - name: Delete database
          linode.cloud.database_postgresql_v2:
            label: "{{ db_create.database.label }}"
            state: absent

        - name: Delete VPC
          linode.cloud.vpc:
            label: "ansible-test-{{ r }}"
            region: "{{ target_region }}"
            state: absent

  environment:
    LINODE_UA_PREFIX: "{{ ua_prefix }}"
    LINODE_API_TOKEN: "{{ api_token }}"
    LINODE_API_URL: "{{ api_url }}"
    LINODE_API_VERSION: "{{ api_version }}"
    LINODE_CA: "{{ ca_file or '' }}"